---
title: "EB 402: Final Exam"
author: "Garrett Eickelberg"
date: "Due: Wednesday, Decmeber 6, 2017"
output: 
  word_document:
    highlight: "monochrome"
    fig_width: 6.5
    fig_height: 4.0
    reference_docx: "/Users/geickelb1/Desktop/epibiostats/hw_solution_template_v3.docx"

    # reference_docx: "C:\\Users\\mnk1805\\Dropbox\\Code\\R\\RMD Templates\\template_small_font_050417.docx"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE, comment="  ", prompt = TRUE)

library(plyr)
library(tidyverse)
library(mice)
library(dplyr)
library(VIM)
library(ggplot2)
library(lattice)
library(Amelia)
library(caret)
#https://www.kaggle.com/captcalculator/imputing-missing-data-with-the-mice-package-in-r  #great reference

```

```{r}
worst<- read.csv("/Users/geickelb1/Documents/GitHub/mimiciii-antibiotics-modeling/data/processed/22112018_worstdf_preImp.csv",stringsAsFactors=TRUE, check.names=FALSE)

worst2<- read.csv("/Users/geickelb1/Documents/GitHub/mimiciii-antibiotics-modeling/data/processed/22112018_worstdf2_preImp.csv",stringsAsFactors=TRUE, check.names=FALSE)
worst2$first_admit_age[worst2$first_admit_age>90]<- 90 #
colnames(worst2)[colnames(worst2)=="('max', 'sodium')"] <- "maxSodium"
colnames(worst2)[colnames(worst2)=="('min', 'sodium')"] <- "minSodium"
colnames(worst2)[colnames(worst2)=="('max', 'calcium')"] <- "maxCalcium"
colnames(worst2)[colnames(worst2)=="('min', 'calcium')"] <- "minCalcium"
colnames(worst2)[colnames(worst2)=="('max', 'sodium')"] <- "maxSodium"
colnames(worst2)[colnames(worst2)=="('min', 'sodium')"] <- "minSodium"
colnames(worst2)[colnames(worst2)=="('max', 'wbc')"] <- "maxWBC"
colnames(worst2)[colnames(worst2)=="('min', 'wbc')"] <- "minWBC"
colnames(worst2)[colnames(worst2)=="bands"] <- "bandsNum"
colnames(worst2)[colnames(worst2)=="pao2/fio2"] <- "pao2fio2Ratio"



final_pt<- read.csv("/Users/geickelb1/Documents/GitHub/mimiciii-antibiotics-modeling/data/raw/csv/01102018_final_pt_df2_v.csv",stringsAsFactors=TRUE, check.names=FALSE)

```

```{r}
##changing 90 to be max age instead of 300
worst2$first_admit_age[worst2$first_admit_age>90]<- 90
worst$first_admit_age[worst$first_admit_age>90]<- 90


worst$dopamine<- as.factor(worst$dopamine == 1)
worst$dobutamine<- as.factor(worst$dobutamine == 1)
worst$vasopressin<- as.factor(worst$vasopressin == 1)
worst$epinephrine<- as.factor(worst$epinephrine == 1)
worst$norepinephrine<- as.factor(worst$norepinephrine == 1)
worst$phenylephrine<- as.factor(worst$phenylephrine == 1)
worst$rrt<- as.factor(worst$rrt == 1)


worst2$dopamine<- as.factor(worst2$dopamine == 1)
worst2$dobutamine<- as.factor(worst2$dobutamine == 1)
worst2$vasopressin<- as.factor(worst2$vasopressin == 1)
worst2$epinephrine<- as.factor(worst2$epinephrine == 1)
worst2$norepinephrine<- as.factor(worst2$norepinephrine == 1)
worst2$phenylephrine<- as.factor(worst2$phenylephrine == 1)
worst2$rrt<- as.factor(worst2$rrt == 1)

```


```{r}
#worst2_outcomes= merge(worst2,final_pt[c('icustay_id','final_bin')], all.x=TRUE)
#worst2_outcomes_sid= merge(worst2,final_pt[c('icustay_id','subject_id','final_bin')], all.x=TRUE)
worst2_sid= merge(worst2,final_pt[c('icustay_id','subject_id', 'final_bin')], all.x=TRUE)
```

```{r}
index <- createDataPartition(worst2_sid$subject_id, p=0.70, list=FALSE)
trainSet <- worst2_sid[ index,]
testSet <- worst2_sid[-index,]

```


```{r}
# training_outcomes_sid= merge(trainSet,final_pt[c('icustay_id','subject_id','final_bin')], all.x=TRUE)

```


```{r}
summary(trainSet)
```
```{r}
pMiss <- function(x){sum(is.na(x))/length(x)*100}

#pMissingWorst= sapply(worst, pMiss) ##% missing data in associated columns. 
pMissing_trainSet= sapply(trainSet, pMiss) ##% missing data in associated columns. 

#pMissingWorst[pMissingWorst>30]
```

```{r}
pMissing_trainSet[pMissing_trainSet>30]
```




```{r}
rowSums(is.na(trainSet)==TRUE)
```



```{r}
md.pattern(trainSet) ##shows the different categories of missingness and the associated n
```

```{r}
aggr(trainSet, col=c('navyblue','red'), numbers=TRUE, sortvars=TRUE) #different visualization of missingness, though i dont undderstand it very well
```

```{r}
missmap(trainSet[-1], col=c('grey', 'steelblue'), y.cex=0.5, x.cex=0.8)

```



```{r}
# ###excluding the values with <50% data filled in. we can come back to the bands later. 
# exclude <- c('pco2', "('max', 'calcium')", "('min', 'calcium')", 'bilirubin', 'lactate')
# include<- setdiff(names(worst2),exclude)
# 
# worst2_raw<- worst2[include]
```


12/3/18:

in yuan's origional email he stated: # Note, do not use discrete variables to impute other variables at all, as you will likely get error report. The reason is likely due to collinearity in the missing pattern, which you can indeed find among the discrete variables.
# For exapmle, in the MICE R package, there is a parameter of prediction matrix
# setting "predM[,c(names(Discrete_Predictors))] <- '0'" works. 

If i'm interpretign this correctly, this means that I should omitt all of my categorical/discrete/factor variables from imputation.


```{r}
#kaggle reference
##imp.train_raw <- mice(train_raw, m=1, method='cart', printFlag=FALSE)

#,'pco2', "('max', 'calcium')", "('min', 'calcium')", 'bilirubin', 'lactate'
#,'pco2', "('max', 'calcium')", "('min', 'calcium')", 'bilirubin', 'lactate' )

#names(training_outcomes_sid) <- c("bands", "bands_var")

imp <- mice(trainSet, m=5, pred=quickpred(trainSet, minpuc=0.25,
                                        exclude=c('ethnicity','final_bin','subject_id',
                                                  'pco2', "minCalcium",  "maxCalcium", 
                                                  'bilirubin', 'lactate')),
                                          seed=99)

#minpuc: A scalar, vector (of size ncol(data)) or matrix (square, of size ncol(data) specifying the minimum threshold(s) for the proportion of usable cases.
```

```{r}
summary(imp)
```



```{r}
#save(imp, file='full_worst_imp.txt')

imp$method
```

```{r}
complete(imp,1)
```

```{r}
complete(imp,2)
```


```{r}
#writing imputed data to a file
for (i in 1:5) {
    worsti = complete(imp,i)
    fnimp = sprintf('/Users/geickelb1/Documents/GitHub/mimiciii-antibiotics-modeling/models/imputation/training_worst%d.txt', i)
    write.table(worsti, file=fnimp)}
```



```{r}
xyplot(imp,final_bin ~ daily_sofa+first_admit_age+rrt,pch=18,cex=1)

#What we would like to see is that the shape of the magenta points (imputed) matches the shape of the blue ones (observed). The matching shape tells us that the imputed values are indeed “plausible values”.

```



```{r}
#densityplot(imp[,-1])

densityplot( x=imp , data= ~potassium)
```

```{r}
stripplot(imp, pch = 20, cex = 1.2)
```

```{r}
#merge(imp,final_pt[c('icustay_id','subject_id','final_bin')], all.x=TRUE)
```
```{r}

```


need to check the porportion in origional data vs the imputed
```{r}
summary((worst2_raw$chloride))

```


```{r}
summary((imp$imp$chloride))
```


```{r}
summary((worst2_raw$mingcs))
```

```{r}
summary(imp$imp$mingcs)
```


```{r}
summary((trainSet$bands))
```


```{r}
summary((imp$imp$bands))
```


```{r}
imp$
```


---------------
splitting cohort into two sets, training and validation. note if pt has >1 icustay_id, they should both end up in same cohort. ie they will be split at the subject_id level.


```{r}
# index <- createDataPartition(train_transformed$Loan_Status, p=0.75, list=FALSE)
# trainSet <- train_transformed[ index,]
# testSet <- train_transformed[-index,]



index <- createDataPartition(worst2_outcomes_sid$subject_id, p=0.70, list=FALSE)
#trainSet <- worst2_outcomes[ index,]
#testSet <- worst2_outcomes[-index,]

```

```{r}
library(car)
library(aplore3)
library(readxl)
library(doBy)
library(knitr)
library(magrittr) 
library(ggplot2)
library(gridExtra)
library(dplyr)
library(alr4)
library(effects)
library(GGally)
library(lsmeans)
library(MASS)
library(Rlab)
library(BlandAltmanLeh)
library(psych)
library(plyr)
library(reshape2)
library(tidyverse)
library(tableone)
library(evaluate)
library(LogisticDx)
```

```{r}
library(miceadds)
```


```{r}
# #imp[index,]
# imp$imp$
# 
# subset_datlist(imp, subset=TRUE, select=NULL, expr_subset=NULL,
#         index=index, toclass="datlist")
```
```{r}
#training model off complete1

modelFit1 <- glm(final_bin~., family=binomial, data=complete(imp,1))#, data=data))
summary(modelFit1)
```

```{r}
summary(modelFit1)$coef %>% printCoefmat()
```


```{r}
Anova(modelFit1)
```



```{r}

#training a model

# tempData2 <- mice(data,m=50,seed=245435)
# modelFit2 <- with(tempData2,lm(Temp~ Ozone+Solar.R+Wind))
# summary(pool(modelFit2))

##logistic regression
#model <- glm(imyopia ~., family=binomial, data=data)

modelFit2 <- with(imp, glm.mids(final_bin~., family=binomial, data=imp))#, data=data))
summary(pool(modelFit2), type='mira')

```


```{r}
library(mice)
library(miceadds)
summary.mira(pool(modelFit2))
```
```{r}
modelFit2
```


```{r}
# 
# mod <- list(analyses=vector("list", imp$m))
# 
# set.seed(1)
# for(i in 1:imp$m){
#   rand <- (1:nrow(worst2_outcomes_sid))*rbinom(nrow(worst2_outcomes_sid),size=1,prob=0.7)
#   mod$analyses[[i]] <- glm(final_bin ~ ., data=complete(imp, i)[rand,],family=binomial)
# }
# 
# class(mod) <- c("mira", "matrix")
# pool(mod)

```


```{r}
# nrow(complete(imp, 1)[index, ]) #5446
# #sum(!duplicated(complete(imp, 1)[index, c('icustay_id')])) #5446
# #sum(!duplicated(df))
```

